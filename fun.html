<!DOCTYPE html>
<html>
<head>
    <!--<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/ocanvas/2.4.0/ocanvas.min.js"></script>-->
    <script type="text/javascript" src="ocanvas-2.4.0.js"></script>

    <style type="text/css">
        #canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
    <title>Fun</title>
</head>
<body>
<canvas id="canvas" width="800" height="500">

</canvas>
</body>
</html>

<script type="text/javascript">
    var canvas = oCanvas.create({ canvas: "#canvas", background: "#FFFFFF" });

    /***********/
	/* ITERATE */
    var iterate = function(s, options) {
        var i;
        var j;
        var r0 = options.r0;
        var r1 = options.r1;
        var n = options.n;
        for (j=0; j < n; j++){
            for (i=0; i < s.length; i++) {
             var c = s[i];
                if (c == '1') {
                    s = s.slice(0, i) + r1 + s.slice(i+1);
                    i += r1.length-1;
                } else if (c == '0') {
                    s = s.slice(0, i) + r0 + s.slice(i+1);
                    i += r0.length-1;
                }
            }
        }
        return s;
    };

    /***********/
    /* BRANCH */
    var branch = function(canvas, parent, x, y, length, angle) {
        var line = canvas.display.line({
            start: {x: x, y: y+length/2},
            end: {x: x, y: y-length/2},
            origin: {y:'bottom'},
            rotation: angle,
            stroke: "3px #000000",
            cap: "round"
        });
        if(parent) {
            parent.addChild(line);
            line.parentRotation = parent.rotation + parent.parentRotation;
        }else {
            canvas.addChild(line);
            line.parentRotation = 0;
        }
        line.originalRotation = angle;

        return line;
    };

    /***********/
    /* DRAW BRANCHES */
    var drawBranches = function(canvas, s, x, y, options) {
        var i = 0; // character counter
        var depth = 0; // recursive level counter
		var stateStack = [];
        var toReturn = [];
        while(i < s.length) {
            var c = s[i];
            if(c == '[') {
				stateStack.push(options);
				// copy options
				options = {
				'angle': options.angle,
				'angleDelta': options.angleDelta,
				'length' : options.length*options.lengthDelta,
				'lengthDelta': options.lengthDelta/options.lengthDelta,
				'parent': options.parent,
				};
                depth++;
            } else if(c == '1') {
                var t = 0;
                while(s[t+i]=='1') {t++} // count the 1s
                i += t - 1; // skip the ones we counted
                var length = options.length * t;
				var _x, _y;
                var _angle;
                if (!options.parent) { // TODO: i hate this..
					_x = x;
					_y = y;
                } else {
					_y = (-1) * options.parent.length;
                    _x = 0;
				}
                var b = branch(canvas, options.parent, _x, _y, length, options.angle);
                b.depth = depth;
                b.angularVelocity = 0;
                options.angle = 0;
                toReturn.push(b);
                options.parent = b;
            } else if (c == '+') {
                options.angle += options.angleDelta;
            } else if (c == '-') {
                options.angle -= options.angleDelta;
            } else if (c == ']') {
				options = stateStack.pop();
                depth--;
			}
            i++;
        }
        return toReturn;
    };

    /**************/
	/* BEGIN MAIN */
    /**************/
    var s = iterate("0", {
        r0 : "1[+0][-0]",
        r1 : "1",
        n  : 9
    });

    var branches = drawBranches(canvas, s, canvas.width/2, canvas.height, {
        'length': 150,
        'angle' : 0,
        'lengthDelta': 0.15,
        'angleDelta' : 24,
        'parent': null
    });

    var restorativeForce;
    var restorativeConstant = -0.1;
    var windForce;
    var friction = 0.8;
    var epsilon = 0.0001;
    var random;
    var applyWind = false;
    var generateWind = function() {
        if (applyWind) {
        random = Math.floor(Math.random() * 7); // [0, 6]
            if (random == 6) windForce = 0.01;
            else {
                windForce *= friction;
            }
        }
        else windForce = 0;
    };
    var stepBranches = function() {
        branches.forEach(function(branch) {
            restorativeForce = restorativeConstant * (branch.rotation-branch.originalRotation);
//            console.log("rotation: " + branch.rotation);
//            console.log("originalRotation: "+ branch.originalRotation);
//            console.log("restorativeForce: " +restorativeForce);
            branch.angularVelocity += restorativeForce;
            branch.angularVelocity += windForce + branch.depth*windForce;
            branch.angularVelocity *= friction;
//            console.log("angularVelocity: " + branch.angularVelocity);
//            console.log("===================");
//            if (branch.angularVelocity < epsilon) branch.angularVelocity = 0;
            branch.rotate(branch.angularVelocity);

        });
    };

    var step = function() {
        generateWind();
        stepBranches(true);
    };

    canvas.bind('mouseup', (function() {
       applyWind = !applyWind;
    }));

    canvas.setLoop(step).start();
    console.log("hello!");
</script>